# http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/sample-templates-services-us-west-2.html#w1ab2c21c45c15c15
# Amazon EC2 instance in a security group Creates an Amazon EC2 instance in an Amazon EC2 security group.
#https://raw.githubusercontent.com/tongueroo/cloudformation-examples/master/templates/single-instance.yml
---
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Gaia Hub Template'
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  InstanceType:
    Description: Gaia Hub EC2 instance type
    Type: String
    Default: t2.micro
    AllowedValues:
    - t2.micro
    ConstraintDescription: must be a valid EC2 instance type.
  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instances
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  DomainName:
    Description: Domain Name to run hub 
    Type: String
  GaiaBucketName:
    Description: S3 Bucket to store data 
    Type: String
Mappings:
  AWSInstanceType2Arch:
    t2.micro:
      Arch: HVM64
  AWSRegionArch2AMI:
    us-west-2:
      HVM64: ami-06958eb37e94ae701
Resources:
  GaiaBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref GaiaBucketName
      AccessControl: PublicRead
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - GET
              - HEAD
              - DELETE
              - POST
            AllowedOrigins:
              - '*'
            ExposeHeaders:
              - 'ETag'
            MaxAge: '0'
  GaiaBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref GaiaBucketName
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:GetObjectVersion'
            Effect: Allow
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref GaiaBucketName
                - /*
            Principal: '*'
  tagPolicy: 
    Type: AWS::IAM::ManagedPolicy
    Properties: 
      ManagedPolicyName: Gaia_Hub_Describe_Tags
      Description: "Policy for Retrieving Tags"
      Path: "/"
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Action: "ec2:Describe*"
            Resource: "*"
          - 
            Effect: "Allow"
            Action: "s3:*"
            Resource: !Ref GaiaBucketName
  tagRole:
    Type: 'AWS::IAM::Role'
    Properties:
      ManagedPolicyArns: [
        !Ref tagPolicy
      ]
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Effect: Allow
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
      Path: /
      RoleName: Gaia_Hub_Tags
  tagProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties: 
      Path: /
      Roles:
        - !Ref tagRole 
      InstanceProfileName: Gaia_Hub
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType:
        Ref: InstanceType
      IamInstanceProfile: !Ref tagProfile
      SecurityGroups:
      - Ref: InstanceSecurityGroup
      KeyName:
        Ref: KeyName
      ImageId:
        Fn::FindInMap:
        - AWSRegionArch2AMI
        - Ref: AWS::Region
        - Fn::FindInMap:
          - AWSInstanceType2Arch
          - Ref: InstanceType
          - Arch
      Tags:
      - Key: Domain
        Value: 
          Ref: DomainName
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH access via port 22
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: '22'
        ToPort: '22'
        CidrIp: 
          Ref: SSHLocation
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
Outputs:
  InstanceId:
    Description: InstanceId of the Gaia Hub
    Value: 
      Ref: EC2Instance
  PublicDNS:
    Description: Public DNSName of the Gaia Hub
    Value:
      Fn::GetAtt:
      - EC2Instance
      - PublicDnsName
  Domain:
    Description: Supplied Domain to use
    Value: 
      Ref: DomainName
  PublicIP:
    Description: Public IP address of the Gaia Hub
    Value:
      Fn::GetAtt:
      - EC2Instance
      - PublicIp
  GaiaBucket:
    Description: S3 Bucket where Gaia Hub Stores data
    Value:
        Ref: GaiaBucket